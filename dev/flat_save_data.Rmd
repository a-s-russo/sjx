---
title: "Comparison of seasonal adjustment and trending methods on Australian data"
author: "Anthony Russo"
date: "`r Sys.Date()`"
output: html_document
---

```{r function-download_ts}
#' download_ts Download and clean ABS time series data
#'
#' @param url Download link to the data
#' @details The URL needs to be a link to the downloadable Excel file corresponding to a table on the webpage of an ABS publication, and not a link to the webpage itself. To obtain such a link (in Windows and using Microsoft Edge), navigate to the 'Data downloads' tab of a publication, right-click on the 'Download XLSX' hyperlink for the chosen table, and select 'Copy link'.
#' @importFrom dplyr mutate rename select_if slice_tail
#' @importFrom janitor clean_names
#' @importFrom lubridate month quarter year ymd
#' @importFrom readxl read_excel
#' @importFrom rlang .data
#' @importFrom stats na.omit
#' @importFrom utils download.file
#' @return A list containing formatted and cleaned time series data and their metadata
#' @export
download_ts <- function(url) {
  # Download data
  raw_data <- tempfile(fileext = ".xlsx")
  download.file(url, raw_data, method = "auto", mode = "wb")
  series_data <- read_excel(raw_data, sheet = "Data1", skip = 9) |>
    slice_tail(n = 500) |> # X-13 in 'seas' will fail if series is too long, so select most recent data
    rename(period = "Series ID") |>
    mutate(period = as.Date(.data$period)) |>
    na.omit() # Some series have different start and end dates, so reduce dataset to complete cases across series
  
  # Download metadata
  series_metadata <-
    read_excel(raw_data,
               sheet = "Index",
               skip = 9,
               col_names = TRUE)
  
  # Remove irrelevant data
  series_metadata <- series_metadata |>
    select_if(~ !all(is.na(.))) |> # Discard empty columns
    na.omit() |> # Discard junk (empty and copyright) rows; note this must come after discarding any empty columns!
    clean_names() |>
    within(rm(list = c("series_start", "series_end")))
  
  # Create common start and end dates across series
  series_metadata <- series_metadata |>
    mutate(
      common_series_start = as.Date(series_data$period[1]),
      common_series_end = as.Date(series_data$period[nrow(series_data)]),
      common_start_year = as.Date(year(ymd(
        .data$common_series_start
      ))),
      common_start_period = as.Date(ifelse(
        series_metadata$freq == "Month", month(ymd(.data$common_series_start)), quarter(ymd(.data$common_series_start))
      )),
      common_end_year = as.Date(year(ymd(
        .data$common_series_end
      ))),
      common_end_period = as.Date(ifelse(
        series_metadata$freq == "Month", month(ymd(.data$common_series_end)), quarter(ymd(.data$common_series_end))
      ))
    )
  
  # Create numeric version of frequency variable
  series_metadata <- series_metadata |>
    mutate(
      freq_name = .data$freq,
      freq_num = ifelse(series_metadata$freq == "Quarter", 4, 12)
    ) |>
    within(rm("freq"))
  
  # Create variables for the publication and table titles
  titles <-
    read_excel(raw_data,
               sheet = "Index",
               range = "B5:B6",
               col_names = FALSE)
  title_pub <- as.character(titles[1, 1])
  title_tab <- as.character(titles[2, 1])
  series_metadata <- series_metadata |>
    mutate(publication = title_pub,
           table = title_tab)
  
  return(list(data = series_data, meta = series_metadata))
}
```

```{r function-run_X13}
#' run_X13 Run X-13ARIMA-SEATS to generate seasonally adjusted or trend estimates for a time series object
#' 
#' @param ts A time series object containing original estimates
#' @param type Optional: "S" for seasonal adjustment, or "T" for trending
#' @details Seasonal adjustment and trending are performed using X-13 rather than SEATS
#' @importFrom seasonal seas
#' @return A time series object containing seasonally adjusted or trend estimates generated by X-13ARIMA-SEATS
#' @export
run_X13 <- function(ts, type) {
  X13_type <- ifelse(type == "S", "seasonaladj", "trend")
  X13_ts <-
    seas(ts, x11 = "")$data[, X13_type] # X11 option specifies X-11; overrides the 'seats' spec
  return(X13_ts)
}
```

```{r function-run_RJD}
#' run_RJD Run JDemetra+ to generate seasonally adjusted or trend estimates for a time series object
#' 
#' @param ts A time series object containing original estimates
#' @param type Optional: "S" for seasonal adjustment, or "T" for trending
#' @details Seasonal adjustment and trending are performed using X-13 rather than SEATS
#' @importFrom RJDemetra x13
#' @return A time series object containing seasonally adjusted or trend estimates generated by JDemetra+
#' @export
run_RJD <- function(ts, type) {
  RJD_type <- ifelse(type == "S", "sa", "t")
  RJD_ts <- x13(ts)$final$series[, RJD_type]
  return(RJD_ts)
}
```

```{r function-create_ts}
#' create_ts Create a time series object for a single series in a downloaded and cleaned table from an ABS publication
#' 
#' @param series A list returned from download_ts containing series and their metadata
#' @param seriesID A series ID
#' @importFrom dplyr filter
#' @importFrom rlang .data
#' @importFrom stats ts
#' @return A time series object for a single series
#' @export
create_ts <- function(series, seriesID) {
  # Return NULL object if series ID is missing
  if (length(seriesID) == 0)
    return(NULL)
  
  # Extract series data and metadata
  data <- series$data
  meta <- series$meta
  
  # Create common start and end periods
  common_start_year <-
    filter(meta, .data$series_id == seriesID)$common_start_year
  common_start_month <-
    filter(meta, .data$series_id == seriesID)$common_start_period
  common_end_year <-
    filter(meta, .data$series_id == seriesID)$common_end_year
  common_end_month <-
    filter(meta, .data$series_id == seriesID)$common_end_period
  
  # Redefine frequency variable
  freq <- filter(meta, .data$series_id == seriesID)$freq_num
  
  return(ts(
    data[, seriesID],
    start = c(common_start_year, common_start_month),
    end = c(common_end_year, common_end_month),
    frequency = freq
  ))
}
```

```{r function-create_ts_comp}
#' create_ts_comp Create a list of time series objects for one group of original, seasonally adjusted and trend series corresponding to a single data item description in a downloaded and cleaned table from an ABS publication in addition to seasonally adjusted and trend series from X-13ARIMA-SEATS and JDemetra+
#'
#' @param series A list returned from download_ts containing series and their metadata
#' @param dataItem The data item description for which results are to be returned
#' @details Requires the data output from download_ts. Null values appear in place of non-existent series in the list returned.
#' @return A list for a single data item description containing the ABS original, seasonally adjusted and trend estimates and associated metadata, along with the seasonally adjusted and trend estimates generated by X-13ARIMA-SEATS and JDemetra+
#' @export
create_ts_comp <- function(series, dataItem) {
  # Extract series metadata
  meta <-
    filter(series$meta, .data$data_item_description == dataItem)
  
  # Extract series IDs
  seriesID_orig <- meta$series_id[meta$series_type == "Original"]
  seriesID_seas <- meta$series_id[meta$series_type == "Seasonally Adjusted"]
  seriesID_tren <- meta$series_id[meta$series_type == "Trend"]
  
  # Generate ABS original, seasonally adjusted and trend time series object
  ABS_orig_ts <- create_ts(series, seriesID_orig)
  ABS_seas_ts <- create_ts(series, seriesID_seas)
  ABS_tren_ts <- create_ts(series, seriesID_tren)
  
  # Generate X-13ARIMA-SEATS seasonally adjusted and trend time series objects
  X13_seas_ts <- run_X13(ABS_orig_ts, "S")
  X13_tren_ts <- run_X13(ABS_orig_ts, "T")
  
  # Generate JDemetra+ seasonally adjusted and trend time series objects
  RJD_seas_ts <- run_RJD(ABS_orig_ts, "S")
  RJD_tren_ts <- run_RJD(ABS_orig_ts, "T")
  
  # Return list of time series objects
  results <- list(
    "metadata" = meta,
    "ABS_orig" = ABS_orig_ts,
    "ABS_seas" = ABS_seas_ts,
    "ABS_tren" = ABS_tren_ts,
    "X13_seas" = X13_seas_ts,
    "X13_tren" = X13_tren_ts,
    "RJD_seas" = RJD_seas_ts,
    "RJD_tren" = RJD_tren_ts
  )
  
  return(results)
}
```

```{r function-create_ts_table}
#' create_ts_table Create a list of time series objects for all original, seasonally adjusted and trend series in a downloaded and cleaned table from an ABS publication in addition to seasonally adjusted and trend series from X-13ARIMA-SEATS and JDemetra+
#'
#' @param series A list returned from download_ts containing series and their metadata
#' @details Requires the data output from download_ts. Null values appear in place of non-existent series in the list returned.
#' @return A list for all data item descriptions containing the ABS original, seasonally adjusted and trend estimates and associated metadata, along with the seasonally adjusted and trend estimates generated by X-13ARIMA-SEATS and JDemetra+
#' @export
create_ts_table <- function(series) {
  # Extract series metadata
  meta <- series$meta
  
  # Extract unique data item descriptons
  unique_dataItems <- unique(meta$data_item_description)
  
  # Initialise empty list
  results <- vector("list", length(unique_dataItems))
  names(results) <- unique_dataItems
  
  # Cycle through each data item description
  for (dataItem in unique_dataItems) {
    # Extract and generate time series objects for current data item description
    results[[dataItem]] <- create_ts_comp(series, dataItem)
  }
  
  return(results)
}
```

```{r, examples-download_ts, echo=FALSE, eval=FALSE}
#' \dontrun{
#' # Construct URL to download ABS data
#' ABS <- "https://www.abs.gov.au/statistics/economy/" # ABS website (for economic statistics)
#' pub <- "business-indicators/business-indicators-australia/" # Publication
#' ref <- "mar-2023/" # Reference period
#' cat <- "567600" # Catalogue number
#' tab <- "3.xlsx" # Table number
#' URL <- paste0(ABS, pub, ref, cat, tab)
#' 
#' # Download and plot data
#' sales <- download_ts(URL)
#' }
```